#!/bin/bash
### BEGIN INIT INFO
# Provides:          {{ aem_cms_service_name }}
# Required-Start:    $local_fs $remote_fs $network $syslog $named
# Required-Stop:     $local_fs $remote_fs $network $syslog $named
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start AEM process
# Description:       Init script for AEM instance {{ aem_cms_service_name }}
### END INIT INFO

# Source function library.
. /lib/lsb/init-functions

SCRIPT_NAME=`basename $0`
AEM_ROOT={{ aem_cms_home }}
AEM_USER={{ aem_cms_user }}
PID_PATH={{ aem_cms_home }}/crx-quickstart/conf/cq.pid
STOP_TIMEOUT_SECONDS={{ aem_cms_stop_timeout_seconds }}


########
BIN=${AEM_ROOT}/crx-quickstart/bin
START=${BIN}/start
STOP=${BIN}/stop
STATUS="${BIN}/status"

aem_start() {
  pidResult=$(pgrep --pidfile $PID_PATH || true);
  if [[ $pidResult != "" ]];
  then
    log_success_msg "$SCRIPT_NAME already started"
  else
    log_daemon_msg "Starting $SCRIPT_NAME"
    su - ${AEM_USER} ${START} > /dev/null
    log_end_msg 0
  fi
}

aem_stop() {
  # check if instance is running
  pidResult=$(pgrep --pidfile $PID_PATH || true);
  if [[ $pidResult != "" ]];
  then
    # AEM is running
    log_daemon_msg "Stopping $SCRIPT_NAME"
    su - ${AEM_USER} -c "bash ${STOP}" > /dev/null
    while [ "$STOP_TIMEOUT_SECONDS" != "0" ]; do
      sleep 1s
      pidResult=$(pgrep --pidfile $PID_PATH || true);
      if [[ $pidResult == "" ]];
      then
        break;
      fi

      log_progress_msg "."
      let STOP_TIMEOUT_SECONDS-=1;

    done
    # check if AEM process has to be terminated
    pidResult=$(pgrep --pidfile $PID_PATH || true);
    if [[ $pidResult != "" ]];
    then
      log_daemon_msg "Killed $SCRIPT_NAME because shutdown timeout was reached"
      kill -9 $(cat $PID_PATH);
    fi
    log_end_msg 0
  else
    # AEM is not running
    log_success_msg "$SCRIPT_NAME already stopped"
    log_end_msg 7
  fi

}

case "$1" in
  start)
    aem_start
  ;;
  stop)
    aem_stop
   ;;
  status)
    su - ${AEM_USER} ${STATUS}
  ;;
  restart)
    aem_stop
    aem_start
  ;;
  *)
    echo "Usage: $SCRIPT_NAME {start|stop|status|restart}"
  exit 1
  ;;
esac
